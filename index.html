<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NANOKINGFISHER - Dynamic Report</title>

  <!-- PDF/Image libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#f2f4f8; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line: rgba(15,23,42,.12); --radius:16px; --shadow: 0 18px 60px rgba(15,23,42,.12);
      --pri:#2563eb; --danger:#ef4444; --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1050px;margin:18px auto;padding:14px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}

    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:12px;
    }
    h2{margin:0;font-size:18px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:none;cursor:pointer;padding:10px 14px;border-radius:12px;font-weight:900;font-size:14px;
    }
    .btn-pri{background:var(--pri);color:#fff}
    .btn-ghost{background:#eef2ff;color:#1e293b}
    .btn-danger{background:#fee2e2;color:#7f1d1d}
    .btn-ok{background:#dcfce7;color:#14532d}
    .hint{font-size:12px;color:var(--muted);line-height:1.5;margin-top:8px}

    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){ .grid2{grid-template-columns:1fr 1fr} }

    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    .field input{
      padding:10px;border:1px solid var(--line);border-radius:12px;font-size:14px;outline:none
    }
    .field input:focus{border-color:rgba(37,99,235,.55);box-shadow:0 0 0 3px rgba(37,99,235,.15)}

    .sectionTitle{
      font-size:12px; font-weight:1000; letter-spacing:.4px; color:#111827;
      margin:8px 0 10px;
      text-transform: uppercase;
    }

    .rows{display:flex;flex-direction:column;gap:8px}
    .row{
      display:grid;
      grid-template-columns: 1fr 140px 40px;
      gap:8px;
      align-items:center;
    }
    .row input{
      width:100%;
      padding:10px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:14px;
      outline:none;
    }
    .row input:focus{border-color:rgba(37,99,235,.55);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .iconBtn{
      width:40px;height:40px;border-radius:12px;
      display:grid;place-items:center;
      font-weight:1000;
      border:1px solid var(--line);
      background:#fff;
    }
    .iconBtn.del{background:#fff1f2;border-color:#fecdd3;color:#9f1239}

    .summaryBox{
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .sumRow{display:flex;justify-content:space-between;gap:10px}
    .sumRow b{white-space:nowrap}
    .sumRow .pos{color:var(--ok)}
    .sumRow .neg{color:var(--danger)}

    /* ====== Screen routing ====== */
    .screen{display:none}
    .screen.active{display:block}

    /* ====== A4 Preview ====== */
    .previewShell{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:10px;
      overflow:auto;
    }

    /* ✅ side space কমাতে padding কমানো হলো */
    .a4{
      width:210mm;
      min-height:297mm;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 12px 40px rgba(0,0,0,.18);
      padding:10mm; /* আগে 16mm ছিল */
    }

    .title{text-align:center}
    .title h1{margin:0;font-size:20px;font-weight:1000}
    .title .sub{margin-top:4px;font-size:12px;color:#475569}
    .title .date{margin-top:8px;font-size:12px;color:#111827}
    .divider{margin:10px 0;border-top:2px solid rgba(15,23,42,.20)}

    /* ✅ Income & Expense এর মাঝের gap বাড়ানো হলো */
    .cols{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:28px; /* আগে 18px ছিল */
      margin-top:6px
    }

    .boxTitle{font-size:12px;font-weight:1000;text-transform:uppercase;color:#111827;margin-bottom:8px}

    table{width:100%;border-collapse:collapse;font-size:12.5px}
    th,td{padding:7px 6px;border-bottom:1px solid rgba(0,0,0,.10)}
    th{background:#f1f5f9;text-align:left;font-weight:1000}
    .amt{text-align:right;white-space:nowrap}

    .totLine{margin-top:10px;border-top:2px solid rgba(15,23,42,.20);padding-top:8px;font-size:12.5px}
    .totRow{display:flex;justify-content:space-between;padding:6px 0}
    .balance{font-weight:1000;font-size:13px}

    @media print{
      body{background:#fff}
      .noPrint{display:none !important}
      .a4{box-shadow:none;border:none}
      .previewShell{padding:0}
    }
  </style>
</head>
<body>

<div class="wrap">

  <!-- ================= FORM SCREEN ================= -->
  <div class="screen active" id="screenForm">
    <div class="panel">

      <div class="topbar">
        <h2>Dynamic Report Form</h2>
        <div class="btns">
          <button class="btn-danger" id="btnReset">Reset (সব 0)</button>
          <button class="btn-pri" id="btnGoPreview">Preview</button>
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Office / Company Name</label>
          <input id="officeName" value="NANOKINGFISHER" />
        </div>

        <div class="field">
          <label>Date Range (Format: dd-mm-yyyy)</label>
          <input id="dateFrom" value="01-01-2026" />
          <div style="height:6px"></div>
          <input id="dateTo" value="31-01-2026" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <!-- Income -->
        <div>
          <div class="sectionTitle">Income (Project name + amount)</div>
          <div class="rows" id="incomeRows"></div>
          <div style="margin-top:10px">
            <button class="btn-ghost" id="btnAddIncome">+ Add Income</button>
          </div>

          <div class="summaryBox">
            <div class="sumRow"><span>Total Income</span> <b id="uiTotalIncome">0</b></div>
          </div>
        </div>

        <!-- Expense -->
        <div>
          <div class="sectionTitle">Expense</div>
          <div class="rows" id="expenseRows"></div>
          <div style="margin-top:10px">
            <button class="btn-ghost" id="btnAddExpense">+ Add Expense</button>
          </div>

          <div class="summaryBox">
            <div class="sumRow"><span>Total Expense</span> <b id="uiTotalExpense">0</b></div>
            <div class="sumRow">
              <span>Balance (Income - Expense)</span>
              <b id="uiBalance" class="">0</b>
            </div>
          </div>
        </div>
      </div>

      <div class="hint">
        • Income/Expense লাইনে নাম লিখুন + amount দিন।<br>
        • + Add দিয়ে যত খুশি লাইন যোগ করুন।<br>
        • Preview চাপলে আলাদা পেজে রিপোর্ট দেখাবে, সেখান থেকে PDF/IMG সেভ করবেন।
      </div>

    </div>
  </div>

  <!-- ================= PREVIEW SCREEN ================= -->
  <div class="screen" id="screenPreview">
    <div class="panel noPrint">
      <div class="topbar">
        <h2>Preview</h2>
        <div class="btns">
          <button class="btn-ghost" id="btnBack">← Back</button>
          <button class="btn-ok" id="btnSaveImg">Save Image</button>
          <button class="btn-pri" id="btnSavePdf">Save PDF</button>
        </div>
      </div>
      <div class="hint">
        • Save Image দিলে JPG ডাউনলোড হবে। • Save PDF দিলে PDF ডাউনলোড হবে।
      </div>
    </div>

    <div class="previewShell">
      <div class="a4" id="a4Doc">

        <div class="title">
          <h1 id="pOffice">NANOKINGFISHER</h1>
          <div class="sub">Custom Report</div>
          <div class="date"><b>Date:</b> <span id="pDateRange">01-01-2026 to 31-01-2026</span></div>
        </div>

        <div class="divider"></div>

        <div class="cols">
          <!-- Income -->
          <div>
            <div class="boxTitle">Income Description</div>
            <table>
              <thead>
              <tr><th>Description</th><th class="amt">Amount</th></tr>
              </thead>
              <tbody id="pIncomeBody"></tbody>
            </table>

            <div class="totLine">
              <div class="totRow">
                <span><b>Total Income</b></span>
                <strong id="pTotalIncome">0</strong>
              </div>
            </div>
          </div>

          <!-- Expense -->
          <div>
            <div class="boxTitle">Expense Description</div>
            <table>
              <thead>
              <tr><th>Description</th><th class="amt">Amount</th></tr>
              </thead>
              <tbody id="pExpenseBody"></tbody>
            </table>

            <div class="totLine">
              <div class="totRow">
                <span><b>Total Expense</b></span>
                <strong id="pTotalExpense">0</strong>
              </div>
            </div>
          </div>
        </div>

<br><br>
        <div class="divider"></div>

        <div class="totRow balance">
          <span>Today Balance</span>
          <strong id="pBalance">0</strong>
        </div>

      </div>
    </div>
  </div>

</div>

<script>
  const el = (id)=>document.getElementById(id);

  function toNum(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }
  function fmt(n){
    return toNum(n).toLocaleString("en-IN");
  }

  let incomeItems = [];
  let expenseItems = [];

  function makeRow({type, index, name="", amount=0}){
    const row = document.createElement("div");
    row.className = "row";

    const nameInput = document.createElement("input");
    nameInput.placeholder = type === "income" ? "Project / Income name" : "Expense name";
    nameInput.value = name;

    const amtInput = document.createElement("input");
    amtInput.type = "number";
    amtInput.placeholder = "0";
    amtInput.value = amount;

    const delBtn = document.createElement("button");
    delBtn.className = "iconBtn del";
    delBtn.type = "button";
    delBtn.textContent = "×";

    function sync(){
      const n = nameInput.value;
      const a = toNum(amtInput.value);
      if(type === "income"){
        incomeItems[index] = { name: n, amount: a };
      }else{
        expenseItems[index] = { name: n, amount: a };
      }
      recalcUI();
    }

    nameInput.addEventListener("input", sync);
    amtInput.addEventListener("input", sync);

    delBtn.addEventListener("click", ()=>{
      if(type === "income"){
        incomeItems.splice(index, 1);
        renderIncomeRows();
      }else{
        expenseItems.splice(index, 1);
        renderExpenseRows();
      }
      recalcUI();
    });

    row.appendChild(nameInput);
    row.appendChild(amtInput);
    row.appendChild(delBtn);
    return row;
  }

  function renderIncomeRows(){
    const wrap = el("incomeRows");
    wrap.innerHTML = "";
    incomeItems.forEach((it, i)=>{
      wrap.appendChild(makeRow({type:"income", index:i, name: it.name, amount: it.amount}));
    });
    if(incomeItems.length === 0){
      incomeItems.push({name:"", amount:0});
      renderIncomeRows();
    }
  }

  function renderExpenseRows(){
    const wrap = el("expenseRows");
    wrap.innerHTML = "";
    expenseItems.forEach((it, i)=>{
      wrap.appendChild(makeRow({type:"expense", index:i, name: it.name, amount: it.amount}));
    });
    if(expenseItems.length === 0){
      expenseItems.push({name:"", amount:0});
      renderExpenseRows();
    }
  }

  function totals(){
    const totalIncome = incomeItems.reduce((s,x)=> s + toNum(x.amount), 0);
    const totalExpense = expenseItems.reduce((s,x)=> s + toNum(x.amount), 0);
    const balance = totalIncome - totalExpense;
    return { totalIncome, totalExpense, balance };
  }

  function recalcUI(){
    const { totalIncome, totalExpense, balance } = totals();
    el("uiTotalIncome").textContent = fmt(totalIncome);
    el("uiTotalExpense").textContent = fmt(totalExpense);
    el("uiBalance").textContent = fmt(balance);
    el("uiBalance").className = balance < 0 ? "neg" : "pos";
  }

  function buildPreviewTables(){
    const office = (el("officeName").value || "").trim() || "NANOKINGFISHER";
    const df = (el("dateFrom").value || "").trim() || "01-01-2026";
    const dt = (el("dateTo").value || "").trim() || "31-01-2026";

    const { totalIncome, totalExpense, balance } = totals();

    el("pOffice").textContent = office;
    el("pDateRange").textContent = `${df} to ${dt}`;
    el("pTotalIncome").textContent = fmt(totalIncome);
    el("pTotalExpense").textContent = fmt(totalExpense);
    el("pBalance").textContent = fmt(balance);

    const iBody = el("pIncomeBody");
    iBody.innerHTML = "";
    const filteredIncome = incomeItems.filter(x => (x.name || "").trim() !== "" || toNum(x.amount) !== 0);
    if(filteredIncome.length === 0){
      iBody.innerHTML = `<tr><td>-</td><td class="amt">0</td></tr>`;
    }else{
      filteredIncome.forEach(x=>{
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        td1.textContent = (x.name || "").trim() || "Income";
        const td2 = document.createElement("td");
        td2.className = "amt";
        td2.textContent = fmt(x.amount);
        tr.appendChild(td1); tr.appendChild(td2);
        iBody.appendChild(tr);
      });
    }

    const eBody = el("pExpenseBody");
    eBody.innerHTML = "";
    const filteredExp = expenseItems.filter(x => (x.name || "").trim() !== "" || toNum(x.amount) !== 0);
    if(filteredExp.length === 0){
      eBody.innerHTML = `<tr><td>-</td><td class="amt">0</td></tr>`;
    }else{
      filteredExp.forEach(x=>{
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        td1.textContent = (x.name || "").trim() || "Expense";
        const td2 = document.createElement("td");
        td2.className = "amt";
        td2.textContent = fmt(x.amount);
        tr.appendChild(td1); tr.appendChild(td2);
        eBody.appendChild(tr);
      });
    }
  }

  function showScreen(which){
    el("screenForm").classList.remove("active");
    el("screenPreview").classList.remove("active");
    el(which).classList.add("active");
    window.scrollTo(0,0);
  }

  async function captureA4Canvas(){
    const node = el("a4Doc");
    const scale = Math.min(3, window.devicePixelRatio || 2);
    return await html2canvas(node, { scale, backgroundColor:"#ffffff", useCORS:true });
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  function safeFileBase(){
    const office = (el("officeName").value || "NANOKINGFISHER").trim().replace(/\s+/g,"_");
    const df = (el("dateFrom").value || "01-01-2026").trim();
    const dt = (el("dateTo").value || "31-01-2026").trim();
    return `${office}_${df}_to_${dt}`;
  }

  async function saveImage(){
    buildPreviewTables();
    const canvas = await captureA4Canvas();
    canvas.toBlob((blob)=>{
      downloadBlob(blob, `${safeFileBase()}.jpg`);
    }, "image/jpeg", 0.95);
  }

  async function savePDF(){
    buildPreviewTables();
    const canvas = await captureA4Canvas();
    const imgData = canvas.toDataURL("image/jpeg", 0.95);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");
    pdf.addImage(imgData, "JPEG", 0, 0, 210, 297);

    const blob = pdf.output("blob");
    downloadBlob(blob, `${safeFileBase()}.pdf`);
  }

  function resetAll(){
    el("officeName").value = "NANOKINGFISHER";
    el("dateFrom").value = "01-01-2026";
    el("dateTo").value = "31-01-2026";

    incomeItems = [{name:"", amount:0}];
    expenseItems = [{name:"", amount:0}];

    renderIncomeRows();
    renderExpenseRows();
    recalcUI();
  }

  el("btnAddIncome").addEventListener("click", ()=>{
    incomeItems.push({name:"", amount:0});
    renderIncomeRows();
    recalcUI();
  });

  el("btnAddExpense").addEventListener("click", ()=>{
    expenseItems.push({name:"", amount:0});
    renderExpenseRows();
    recalcUI();
  });

  el("btnReset").addEventListener("click", resetAll);

  el("btnGoPreview").addEventListener("click", ()=>{
    recalcUI();
    buildPreviewTables();
    showScreen("screenPreview");
  });

  el("btnBack").addEventListener("click", ()=> showScreen("screenForm"));
  el("btnSaveImg").addEventListener("click", saveImage);
  el("btnSavePdf").addEventListener("click", savePDF);

  resetAll();
</script>

</body>
</html>
